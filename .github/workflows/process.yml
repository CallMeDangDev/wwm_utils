# The action to unpack a words_map file

name: Process words_map file

on:
  workflow_dispatch:
    inputs:
      words_map:
        description: 'URL download words_map'
        required: true
        default: ""
        type: string
      hotfix_file:
        description: 'URL download hotfix file (Release.zip)'
        required: false
        default: ""
        type: string

jobs:
  process:
    name: Process words_map
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make wwm_utils executable
        run: chmod +x wwm_utils

      - name: Download words_map file
        run: |
          wget -O translate_words_map_zh_cn "${{ github.event.inputs.words_map }}"
          mv translate_words_map_zh_cn translate_words_map_en

      - name: Download and extract hotfix file
        if: github.event.inputs.hotfix_file != ''
        run: |
          wget -O Release.zip "${{ github.event.inputs.hotfix_file }}"
          unzip Release.zip
          ls -la

      - name: Unpack words_map
        run: |
          ./wwm_utils translate_words_map_en

      - name: Apply hotfix to entries.json
        if: github.event.inputs.hotfix_file != ''
        run: |
          python3 << 'EOF'
          import json
          import csv
          import os

          # Đọc entries.json
          entries_path = "output/translate_words_map_en/entries.json"
          with open(entries_path, 'r', encoding='utf-8') as f:
              entries = json.load(f)

          # Đọc hotfix.csv
          if os.path.exists('hotfix.csv'):
              print("Found hotfix.csv, processing...")
              
              # Đếm tổng số dòng trong CSV
              with open('hotfix.csv', 'r', encoding='utf-8-sig') as f:
                  total_rows = sum(1 for _ in csv.DictReader(f))
              
              print(f"Total entries in hotfix: {total_rows}")
              
              with open('hotfix.csv', 'r', encoding='utf-8-sig') as f:
                  reader = csv.DictReader(f)
                  
                  count = 0
                  not_found_list = []
                  processed = 0
                  
                  for row in reader:
                      processed += 1
                      
                      # In progress mỗi 100,000 entries
                      if processed % 100000 == 0:
                          print(f"Progress: {processed}/{total_rows} entries processed...")
                      
                      # Lấy ID từ CSV
                      key_str = row.get('ID', '').strip().strip("'\"")
                      translation = row.get('Translation', '').strip()
                      original_text = row.get('OriginalText', '').strip()
                      
                      if not key_str or not translation:
                          continue
                      
                      try:
                          # Parse số từ string
                          signed_value = int(key_str)
                          
                          # Nếu là số âm, convert sang unsigned 64-bit
                          if signed_value < 0:
                              # Convert i64 -> u64: thêm 2^64
                              unsigned_value = signed_value + (1 << 64)
                              key = str(unsigned_value)
                          else:
                              key = key_str
                          
                          if key in entries:
                              entries[key] = translation
                              count += 1
                          else:
                              not_found_list.append({
                                  'id': key_str,
                                  'original': original_text,
                                  'translation': translation
                              })
                      except ValueError:
                          pass
              
              print(f"\n{'='*60}")
              print(f"Processed: {processed} entries")
              print(f"Patched: {count} entries")
              print(f"Not found: {len(not_found_list)} entries")
              
              if not_found_list:
                  print(f"\n{'='*60}")
                  print("Keys not found in entries.json:")
                  print(f"{'='*60}")
                  for item in not_found_list:
                      print(f"ID: {item['id']}")
                      if item['original']:
                          print(f"  Original: {item['original']}")
                      print(f"  Translation: {item['translation']}")
                      print()
              
              # Ghi lại entries.json
              with open(entries_path, 'w', encoding='utf-8') as f:
                  json.dump(entries, f, ensure_ascii=False, indent=2)
          else:
              print("hotfix.csv not found, skipping patch")
          EOF

      - name: Pack words_map
        run: |
          ./wwm_utils output/translate_words_map_en

      - name: Prepare release files
        run: |
          mkdir -p release_files
          cp output/translate_words_map_en/merged/translate_words_map_en release_files/
          cd release_files
          zip translate_words_map_en.zip translate_words_map_en

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ steps.date.outputs.date }}
          name: Words Map Release ${{ steps.date.outputs.date }}
          body: |
            Processed words_map file with hotfix applied
            
            - Source: ${{ github.event.inputs.words_map }}
            - Hotfix: ${{ github.event.inputs.hotfix_file || 'None' }}
          files: |
            release_files/translate_words_map_en
            release_files/translate_words_map_en.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}