# The action to unpack a words_map file

name: Process words_map file

on:
  workflow_dispatch:
    inputs:
      words_map:
        description: 'URL download words_map'
        required: true
        default: ""
        type: string
      hotfix_file:
        description: 'URL download hotfix file (Release.zip)'
        required: false
        default: ""
        type: string

jobs:
  process:
    name: Process words_map
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make wwm_utils executable
        run: chmod +x wwm_utils

      - name: Download words_map file
        run: |
          wget -O translate_words_map_zh_cn "${{ github.event.inputs.words_map }}"

      - name: Download and extract hotfix file
        if: github.event.inputs.hotfix_file != ''
        run: |
          wget -O Release.zip "${{ github.event.inputs.hotfix_file }}"
          unzip Release.zip
          ls -la

      - name: Unpack words_map
        run: |
          ./wwm_utils translate_words_map_zh_cn

      - name: Apply hotfix to entries.json
        if: github.event.inputs.hotfix_file != ''
        run: |
          python3 << 'EOF'
          import json
          import csv
          import os

          # Đọc entries.json
          entries_path = "output/translate_words_map_zh_cn/entries.json"
          with open(entries_path, 'r', encoding='utf-8') as f:
              entries = json.load(f)

          # Đọc hotfix.csv
          if os.path.exists('hotfix.csv'):
              print("Found hotfix.csv, processing...")
              with open('hotfix.csv', 'r', encoding='utf-8-sig') as f:
                  reader = csv.DictReader(f)
                  
                  count = 0
                  not_found = []
                  for row in reader:
                      # Lấy ID từ CSV
                      key_str = row.get('ID', '').strip().strip("'\"")
                      translation = row.get('Translation', '').strip()
                      
                      if not key_str or not translation:
                          continue
                      
                      try:
                          # Parse số từ string
                          signed_value = int(key_str)
                          
                          # Nếu là số âm, convert sang unsigned 64-bit
                          if signed_value < 0:
                              # Convert i64 -> u64: thêm 2^64
                              unsigned_value = signed_value + (1 << 64)
                              key = str(unsigned_value)
                          else:
                              key = key_str
                          
                          if key in entries:
                              entries[key] = translation
                              count += 1
                              if signed_value < 0:
                                  print(f"✓ Patched (converted {signed_value}): {key} -> {translation}")
                              else:
                                  print(f"✓ Patched: {key} -> {translation}")
                          else:
                              not_found.append((key_str, key if signed_value < 0 else None))
                              if signed_value < 0:
                                  print(f"✗ Key not found: {signed_value} (tried as {key})")
                              else:
                                  print(f"✗ Key not found: {key}")
                      except ValueError as e:
                          print(f"⚠ Invalid ID format: {key_str}")
              
              print(f"\n{'='*60}")
              print(f"Total patched: {count} entries")
              print(f"Not found: {len(not_found)} entries")
              
              # Ghi lại entries.json
              with open(entries_path, 'w', encoding='utf-8') as f:
                  json.dump(entries, f, ensure_ascii=False, indent=2)
          else:
              print("hotfix.csv not found, skipping patch")
          EOF

      - name: Pack words_map
        run: |
          ./wwm_utils output/translate_words_map_zh_cn

      - name: Prepare release files
        run: |
          mkdir -p release_files
          cp output/translate_words_map_zh_cn/merged/translate_words_map_zh_cn release_files/
          cd release_files
          zip translate_words_map_zh_cn.zip translate_words_map_zh_cn

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ steps.date.outputs.date }}
          name: Words Map Release ${{ steps.date.outputs.date }}
          body: |
            Processed words_map file with hotfix applied
            
            - Source: ${{ github.event.inputs.words_map }}
            - Hotfix: ${{ github.event.inputs.hotfix_file || 'None' }}
          files: |
            release_files/translate_words_map_zh_cn
            release_files/translate_words_map_zh_cn.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}